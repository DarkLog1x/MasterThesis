---
- hosts: all
  remote_user: ubuntu
  gather_facts: no
  pre_tasks:
    - name: Update and install python
      apt: pkg={{ item }} state=installed update-cache=yes
      with_items:
        - python
        - python-dev
        - python-setuptools
        - git-core
        - gcc
        - nmap
        - ruby
        - ruby-dev
        - libsqlite3-dev
        - make
        - htop
        - nload

  vars_prompt:
    - name: "source_file"
      prompt: "Enter password"
      private: yes

  tasks:
    - name: ping google
      action: ping

    - name: install pip
      action: easy_install name=pip

    - name: install openstack client and sqlalchemy
      become: yes
      become_method: sudo
      action: command pip install python-openstackclient python-neutronclient tinydb
    - name: install gem
      become: yes
      become_method: sudo
      action: command gem install ssh_scan

    - name: copy file main
      copy:
        src: "{{ item }}"
        dest: /home/ubuntu/
        owner: ubuntu
        group: ubuntu
        mode: 0755
      with_fileglob:
        - /home/groot/Documents/Uppsala/masterThesis/code/python/*


    - name: run python
      environment:
        OS_PASSWORD: '{{source_file}}'
        OS_AUTH_URL: https://smog.uppmax.uu.se:5000/v3
        OS_TENANT_ID: bfe0cca393a5473189c05f22a731bfd0
        OS_TENANT_NAME: "c2015003"
        OS_PROJECT_NAME: "c2015003"
        OS_USERNAME: "aleko"
        OS_USER_DOMAIN_NAME: Default
        OS_PROJECT_DOMAIN_NAME: Default
        OS_IDENTITY_API_VERSION: 3
        OS_AUTH_VERSION: 3
        OS_REGION_NAME: "UPPMAX"
      command: python main.py
      register: out
    - debug: var=out.stdout_lines

  handlers:
    - name: ping again
      action: ping
